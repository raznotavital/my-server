<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <style>
    body { font-family: Arial; background-color: #ffe6f0; text-align: center; padding: 40px; }
    form { background: white; display: inline-block; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input { margin: 10px 0; padding: 10px; width: 80%; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; background-color: #FF69B4; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Login</h2>
  <form id="loginForm">
    <input type="email" id="email" placeholder="Email" required><br>
    <input type="password" id="password" placeholder="Password" required><br>
    <button type="submit">Login</button>
  </form>

<script>
    // Initialize elements
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const profileBtn = document.getElementById('profileBtn');
    const videoShortsBtn = document.getElementById('videoShortsBtn');
    const messagesBtn = document.getElementById('messagesBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loggedInStatus = document.getElementById('loggedInStatus');
    const teacherList = document.getElementById('teacherList');

    // Add event listeners
    loginBtn.addEventListener('click', () => window.location.href = 'login.html');
    signupBtn.addEventListener('click', () => window.location.href = 'signup.html');
    profileBtn.addEventListener('click', () => window.location.href = 'profile.html');
    videoShortsBtn.addEventListener('click', () => window.location.href = 'video-shorts.html');
    messagesBtn.addEventListener('click', () => window.location.href = 'messages.html');
    logoutBtn.addEventListener('click', logout);

    let currentUser = JSON.parse(localStorage.getItem("currentUser"));
    let allUsers = []; // שיניתי את השם מ-users ל-allUsers כדי להבדיל מ-currentUser

    function logout() {
      localStorage.removeItem("currentUser");
      currentUser = null;
      updateUI();
      location.reload();
    }

    function loadTeachers() {
      teacherList.innerHTML = "";
      const teachers = allUsers.filter(u => u.role === "teacher");

      if (teachers.length === 0) {
        teacherList.innerHTML = "<p>No teachers found</p>";
        return;
      }

      teachers.forEach(teacher => {
        const card = document.createElement("div");
        card.className = "teacher-card";
        card.addEventListener('click', () => {
          localStorage.setItem("selectedTeacher", JSON.stringify({
            name: teacher.name,
            email: teacher.email,
            profileImage: teacher.profileImage || "",
            description: teacher.description || ""
          }));
          window.location.href = "video.html";
        });

        const img = document.createElement("img");
        img.src = teacher.profileImage || "https://www.gravatar.com/avatar?d=mp&f=y";
        img.alt = teacher.name;
        img.onerror = function() {
          this.src = "https://www.gravatar.com/avatar?d=mp&f=y";
        };

        const name = document.createElement("h3");
        name.textContent = teacher.name;

        const specialty = document.createElement("p");
        specialty.textContent = teacher.specialty || "No specialty";

        card.appendChild(img);
        card.appendChild(name);
        card.appendChild(specialty);
        teacherList.appendChild(card);
      });
    }

    function updateUI() {
      if (currentUser) {
        loginBtn.style.display = "none";
        signupBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        messagesBtn.style.display = "inline-block";
        loggedInStatus.textContent = `Logged in as: ${currentUser.name}`;
        
        // אם המשתמש הוא מורה, נוסיף כפתור ניהול
        if (currentUser.role === "teacher") {
          const manageBtn = document.getElementById('manageBtn') || document.createElement('button');
          manageBtn.id = 'manageBtn';
          manageBtn.textContent = 'Manage';
          manageBtn.style.display = 'inline-block';
          manageBtn.addEventListener('click', () => window.location.href = 'manage.html');
          document.querySelector('.nav-buttons').appendChild(manageBtn);
        }
      } else {
        loginBtn.style.display = "inline-block";
        signupBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        messagesBtn.style.display = "none";
        loggedInStatus.textContent = "";
        
        // הסרת כפתור הניהול אם קיים
        const manageBtn = document.getElementById('manageBtn');
        if (manageBtn) manageBtn.remove();
      }
    }

    async function fetchAllUsers() {
      const loadingDiv = document.getElementById('loadingTeachers');
      const errorDiv = document.getElementById('teachersError');
      
      try {
        loadingDiv.style.display = 'block';
        errorDiv.style.display = 'none';
        
        const response = await fetch('/api/users');
        
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }
        
        allUsers = await response.json();
        
        if (!Array.isArray(allUsers)) {
          throw new Error('Invalid data format - expected array');
        }
        
        loadTeachers();
        
        // בדיקה אם המשתמש הנוכחי עדיין קיים בנתונים
        if (currentUser) {
          const userExists = allUsers.some(u => u.email === currentUser.email);
          if (!userExists) {
            logout(); // אם המשתמש לא קיים יותר, ניצור logout אוטומטי
          }
        }
        
      } catch (error) {
        console.error('Error loading users:', error);
        errorDiv.textContent = `Failed to load users: ${error.message}`;
        errorDiv.style.display = 'block';
        
        // נתוני גיבוי
        allUsers = [
          {
            "name": "Default Teacher",
            "email": "teacher@example.com",
            "role": "teacher",
            "profileImage": "https://www.gravatar.com/avatar?d=identicon",
            "specialty": "General Education"
          },
          {
            "name": "Default Student",
            "email": "student@example.com",
            "role": "student"
          }
        ];
        loadTeachers();
      } finally {
        loadingDiv.style.display = 'none';
      }
    }

    // Initialize
    fetchAllUsers();
    updateUI();
  </script>
</body>
</html>
